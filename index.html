<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dunning Industries RFP Tracker</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
        header { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; padding: 30px; text-align: center; }
        header h1 { font-size: 2.5em; margin-bottom: 10px; }
        header p { opacity: 0.9; font-size: 1.1em; }
        .divisions { display: flex; justify-content: center; gap: 15px; padding: 20px; background: #f8f9fa; flex-wrap: wrap; }
        .division-btn { padding: 12px 24px; border: 2px solid #ddd; background: white; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600; transition: all 0.3s; }
        .division-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .division-btn.active { color: white; border-color: transparent; }
        .division-btn.all.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .division-btn.tree.active { background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%); }
        .division-btn.stone.active { background: linear-gradient(135deg, #4b6cb7 0%, #182848 100%); }
        .division-btn.gravel.active { background: linear-gradient(135deg, #f2994a 0%, #f2c94c 100%); }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; padding: 30px; background: #f8f9fa; }
        .stat-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .stat-number { font-size: 2.5em; font-weight: 700; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .stat-label { color: #6c757d; font-size: 0.9em; margin-top: 5px; }
        .controls { padding: 30px; background: white; border-bottom: 2px solid #e9ecef; }
        .search-box { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        input, select { flex: 1; min-width: 200px; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; }
        button { padding: 12px 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600; transition: all 0.3s; }
        button:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); }
        button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .export-btn { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); margin-left: 10px; }
        .results { padding: 30px; min-height: 400px; }
        .loading { text-align: center; padding: 60px; color: #667eea; font-size: 1.2em; }
        .rfp-card { background: white; border: 2px solid #e9ecef; border-radius: 12px; padding: 20px; margin-bottom: 15px; transition: all 0.3s; }
        .rfp-card:hover { border-color: #667eea; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1); transform: translateX(5px); }
        .rfp-title { font-size: 1.3em; font-weight: 700; color: #2c3e50; margin-bottom: 8px; }
        .division-badge { display: inline-block; padding: 6px 12px; border-radius: 6px; font-size: 0.85em; font-weight: 600; color: white; margin-right: 10px; }
        .badge-tree { background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%); }
        .badge-stone { background: linear-gradient(135deg, #4b6cb7 0%, #182848 100%); }
        .badge-gravel { background: linear-gradient(135deg, #f2994a 0%, #f2c94c 100%); }
        .badge-multi { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .rfp-meta { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-top: 15px; font-size: 0.95em; color: #6c757d; }
        .meta-label { font-weight: 600; color: #495057; margin-right: 5px; }
        .value-badge { display: inline-block; padding: 4px 12px; background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; border-radius: 6px; font-weight: 600; font-size: 1.1em; }
        .no-results { text-align: center; padding: 60px; color: #6c757d; font-size: 1.2em; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üèóÔ∏è Dunning Industries RFP Tracker</h1>
            <p>Multi-Division Government Contract Opportunities</p>
        </header>
        
        <div class="divisions">
            <button class="division-btn all active" onclick="setDivision('all')">All Divisions</button>
            <button class="division-btn tree" onclick="setDivision('tree')">üå≥ Tree & Landscape</button>
            <button class="division-btn stone" onclick="setDivision('stone')">ü™® Stone & Supply</button>
            <button class="division-btn gravel" onclick="setDivision('gravel')">‚õèÔ∏è Sand & Gravel</button>
        </div>
        
        <div class="stats">
            <div class="stat-card"><div class="stat-number" id="totalRFPs">0</div><div class="stat-label">Total Opportunities</div></div>
            <div class="stat-card"><div class="stat-number" id="totalValue">$0</div><div class="stat-label">Total Contract Value</div></div>
            <div class="stat-card"><div class="stat-number" id="highValue">0</div><div class="stat-label">High-Value ($100K+)</div></div>
        </div>
        
        <div class="controls">
            <div class="search-box">
                <input type="text" id="keyword" placeholder="Search keywords (optional)">
                <select id="state">
                    <option value="CT">Connecticut</option>
                    <option value="">All States</option>
                    <option value="NY">New York</option>
                    <option value="MA">Massachusetts</option>
                    <option value="RI">Rhode Island</option>
                </select>
                <input type="number" id="minValue" placeholder="Min Value ($)" min="0">
                <button onclick="searchRFPs()" id="searchBtn">üîç Search Opportunities</button>
                <button class="export-btn" onclick="exportToCSV()" id="exportBtn">üìä Export CSV</button>
            </div>
        </div>
        
        <div class="results" id="results">
            <div class="no-results">Click "Search Opportunities" to find RFPs for your selected division</div>
        </div>
    </div>

    <script>
        const API_KEY = 'SAM-07e40872-6088-43c2-9e30-4768dbc60b0a';
        let currentDivision = 'all';
        let allResults = [];
        
        const divisions = {
            tree: { name: 'Tree & Landscape', naics: ['561730', '111421', '238910'], keywords: ['tree', 'landscape', 'nursery', 'landscaping', 'grounds', 'arborist', 'lawn', 'park'] },
            stone: { name: 'Stone & Supply', naics: ['423320', '444190', '327390'], keywords: ['stone', 'masonry', 'hardscape', 'paving', 'brick', 'concrete', 'building materials', 'retaining'] },
            gravel: { name: 'Sand & Gravel', naics: ['212321', '212319', '327320'], keywords: ['sand', 'gravel', 'aggregate', 'crushed stone', 'construction materials', 'excavation', 'fill'] }
        };
        
        function setDivision(div) {
            currentDivision = div;
            document.querySelectorAll('.division-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.division-btn.${div}`).classList.add('active');
        }
        
        function detectDivision(title) {
            const text = title.toLowerCase();
            let matches = [];
            Object.keys(divisions).forEach(key => {
                if (divisions[key].keywords.some(kw => text.includes(kw.toLowerCase()))) matches.push(key);
            });
            return matches.length > 1 ? 'multi' : matches.length === 1 ? matches[0] : 'tree';
        }
        
        async function searchRFPs() {
            const btn = document.getElementById('searchBtn');
            const results = document.getElementById('results');
            btn.disabled = true;
            results.innerHTML = '<div class="loading">‚è≥ Searching SAM.gov database...</div>';
            
            try {
                const today = new Date();
                const oneYearAgo = new Date(today);
                oneYearAgo.setFullYear(today.getFullYear() - 1);
                const formatDate = (d) => `${String(d.getMonth() + 1).padStart(2, '0')}/${String(d.getDate()).padStart(2, '0')}/${d.getFullYear()}`;
                
                let searchTerms = currentDivision === 'all' ? ['landscape', 'stone', 'gravel'] : divisions[currentDivision].keywords.slice(0, 3);
                const keyword = document.getElementById('keyword').value;
                if (keyword) searchTerms = [keyword];
                const state = document.getElementById('state').value;
                const minValue = document.getElementById('minValue').value;
                
                allResults = [];
                for (const term of searchTerms) {
                    let url = `https://api.sam.gov/opportunities/v2/search?api_key=${API_KEY}&postedFrom=${formatDate(oneYearAgo)}&postedTo=${formatDate(today)}&limit=100`;
                    if (term) url += `&title=${encodeURIComponent(term)}`;
                    if (state) url += `&state=${state}`;
                    
                    const response = await fetch(url);
                    const data = await response.json();
                    if (data.opportunitiesData) {
                        data.opportunitiesData.forEach(opp => {
                            if (!allResults.find(r => r.noticeId === opp.noticeId)) {
                                const div = detectDivision(opp.title);
                                const value = extractValue(opp.title);
                                if (!minValue || value >= parseInt(minValue)) {
                                    allResults.push({...opp, division: div, estimatedValue: value});
                                }
                            }
                        });
                    }
                }
                
                displayResults();
                updateStats();
            } catch (error) {
                results.innerHTML = '<div class="no-results">‚ùå Error searching. Please try again.</div>';
                console.error(error);
            } finally {
                btn.disabled = false;
            }
        }
        
        function extractValue(text) {
            const matches = text.match(/\$[\d,]+/g);
            if (matches) {
                const value = parseInt(matches[0].replace(/[$,]/g, ''));
                return value;
            }
            return 0;
        }
        
        function displayResults() {
            const results = document.getElementById('results');
            if (allResults.length === 0) {
                results.innerHTML = '<div class="no-results">No opportunities found. Try different search criteria.</div>';
                return;
            }
            
            let html = '';
            allResults.forEach(opp => {
                const badgeClass = `badge-${opp.division}`;
                const divName = opp.division === 'multi' ? 'Multiple Divisions' : divisions[opp.division]?.name || 'General';
                html += `
                    <div class="rfp-card">
                        <div class="rfp-title">
                            <span class="division-badge ${badgeClass}">${divName}</span>
                            ${opp.title}
                        </div>
                        <div class="rfp-meta">
                            <div><span class="meta-label">RFP #:</span>${opp.solicitationNumber || opp.noticeId}</div>
                            <div><span class="meta-label">Agency:</span>${opp.fullParentPathName || 'N/A'}</div>
                            <div><span class="meta-label">Posted:</span>${new Date(opp.postedDate).toLocaleDateString()}</div>
                            <div><span class="meta-label">Deadline:</span>${opp.responseDeadLine ? new Date(opp.responseDeadLine).toLocaleDateString() : 'N/A'}</div>
                            ${opp.estimatedValue > 0 ? `<div><span class="meta-label">Est. Value:</span><span
