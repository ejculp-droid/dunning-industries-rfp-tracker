<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dunning Industries RFP Tracker</title>
  <style>
    :root {
      /* Primitive Color Tokens */
      --color-white: rgba(255, 255, 255, 1);
      --color-black: rgba(0, 0, 0, 1);
      --color-cream-50: rgba(252, 252, 249, 1);
      --color-cream-100: rgba(255, 255, 253, 1);
      --color-gray-200: rgba(245, 245, 245, 1);
      --color-gray-300: rgba(167, 169, 169, 1);
      --color-gray-400: rgba(119, 124, 124, 1);
      --color-slate-500: rgba(98, 108, 113, 1);
      --color-brown-600: rgba(94, 82, 64, 1);
      --color-charcoal-700: rgba(31, 33, 33, 1);
      --color-charcoal-800: rgba(38, 40, 40, 1);
      --color-slate-900: rgba(19, 52, 59, 1);
      --color-teal-300: rgba(50, 184, 198, 1);
      --color-teal-400: rgba(45, 166, 178, 1);
      --color-teal-500: rgba(33, 128, 141, 1);
      --color-teal-600: rgba(29, 116, 128, 1);
      --color-teal-700: rgba(26, 104, 115, 1);
      --color-teal-800: rgba(41, 150, 161, 1);
      --color-red-400: rgba(255, 84, 89, 1);
      --color-red-500: rgba(192, 21, 47, 1);
      --color-orange-400: rgba(230, 129, 97, 1);
      --color-orange-500: rgba(168, 75, 47, 1);

      --color-brown-600-rgb: 94, 82, 64;
      --color-teal-500-rgb: 33, 128, 141;
      --color-slate-900-rgb: 19, 52, 59;
      --color-slate-500-rgb: 98, 108, 113;
      --color-red-500-rgb: 192, 21, 47;
      --color-red-400-rgb: 255, 84, 89;
      --color-orange-500-rgb: 168, 75, 47;
      --color-orange-400-rgb: 230, 129, 97;

      --color-bg-1: rgba(59, 130, 246, 0.08);
      --color-bg-2: rgba(245, 158, 11, 0.08);
      --color-bg-3: rgba(34, 197, 94, 0.08);
      --color-bg-4: rgba(239, 68, 68, 0.08);

      --color-background: var(--color-cream-50);
      --color-surface: var(--color-cream-100);
      --color-text: var(--color-slate-900);
      --color-text-secondary: var(--color-slate-500);
      --color-primary: var(--color-teal-500);
      --color-primary-hover: var(--color-teal-600);
      --color-primary-active: var(--color-teal-700);
      --color-secondary: rgba(var(--color-brown-600-rgb), 0.12);
      --color-secondary-hover: rgba(var(--color-brown-600-rgb), 0.2);
      --color-border: rgba(var(--color-brown-600-rgb), 0.2);
      --color-btn-primary-text: var(--color-cream-50);
      --color-card-border: rgba(var(--color-brown-600-rgb), 0.12);
      --color-error: var(--color-red-500);
      --color-success: var(--color-teal-500);
      --color-warning: var(--color-orange-500);
      --color-focus-ring: rgba(var(--color-teal-500-rgb), 0.4);

      --focus-ring: 0 0 0 3px var(--color-focus-ring);
      --color-success-rgb: 33, 128, 141;
      --color-error-rgb: 192, 21, 47;
      --color-warning-rgb: 168, 75, 47;

      --font-family-base: "FKGroteskNeue", "Geist", "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      --font-size-xs: 11px;
      --font-size-sm: 12px;
      --font-size-base: 14px;
      --font-size-lg: 16px;
      --font-size-xl: 18px;
      --font-size-2xl: 20px;
      --font-size-3xl: 24px;
      --font-size-4xl: 30px;
      --font-weight-normal: 400;
      --font-weight-medium: 500;
      --font-weight-semibold: 550;
      --font-weight-bold: 600;
      --line-height-normal: 1.5;

      --space-4: 4px;
      --space-6: 6px;
      --space-8: 8px;
      --space-10: 10px;
      --space-12: 12px;
      --space-16: 16px;
      --space-20: 20px;
      --space-24: 24px;
      --space-32: 32px;

      --radius-base: 8px;
      --radius-md: 10px;
      --radius-lg: 12px;
      --radius-full: 9999px;

      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.02);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.04), 0 2px 4px -1px rgba(0, 0, 0, 0.02);

      --duration-fast: 150ms;
      --duration-normal: 250ms;
      --ease-standard: cubic-bezier(0.16, 1, 0.3, 1);
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --color-gray-400-rgb: 119, 124, 124;
        --color-teal-300-rgb: 50, 184, 198;
        --color-gray-300-rgb: 167, 169, 169;
        --color-gray-200-rgb: 245, 245, 245;

        --color-bg-1: rgba(29, 78, 216, 0.15);
        --color-bg-2: rgba(180, 83, 9, 0.15);
        --color-bg-3: rgba(21, 128, 61, 0.15);
        --color-bg-4: rgba(185, 28, 28, 0.15);

        --color-background: var(--color-charcoal-700);
        --color-surface: var(--color-charcoal-800);
        --color-text: var(--color-gray-200);
        --color-text-secondary: rgba(var(--color-gray-300-rgb), 0.7);
        --color-primary: var(--color-teal-300);
        --color-primary-hover: var(--color-teal-400);
        --color-primary-active: var(--color-teal-800);
        --color-secondary: rgba(var(--color-gray-400-rgb), 0.15);
        --color-secondary-hover: rgba(var(--color-gray-400-rgb), 0.25);
        --color-border: rgba(var(--color-gray-400-rgb), 0.3);
        --color-error: var(--color-red-400);
        --color-success: var(--color-teal-300);
        --color-warning: var(--color-orange-400);
        --color-focus-ring: rgba(var(--color-teal-300-rgb), 0.4);
        --color-btn-primary-text: var(--color-slate-900);
        --color-card-border: rgba(var(--color-gray-400-rgb), 0.2);

        --color-success-rgb: var(--color-teal-300-rgb);
        --color-error-rgb: var(--color-red-400-rgb);
        --color-warning-rgb: var(--color-orange-400-rgb);
      }
    }

    @font-face {
      font-family: 'FKGroteskNeue';
      src: url('https://r2cdn.perplexity.ai/fonts/FKGroteskNeue.woff2') format('woff2');
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); min-height:100vh; padding:20px; }
    .container{ max-width:1400px; margin:0 auto; background:white; border-radius:20px; box-shadow:0 20px 60px rgba(0,0,0,0.3); overflow:hidden;}
    header{ background:linear-gradient(135deg,#1e3c72 0%,#2a5298 100%); color:white; padding:30px; text-align:center;}
    header h1{ font-size:2.5em; margin-bottom:10px;}
    header p{ opacity:0.9; font-size:1.1em;}
    .divisions{ display:flex; justify-content:center; gap:15px; padding:20px; background:#f8f9fa; flex-wrap:wrap;}
    .division-btn{ padding:12px 24px; border:2px solid #ddd; background:white; border-radius:8px; cursor:pointer; font-size:16px; font-weight:600; transition:all .3s;}
    .division-btn:hover{ transform:translateY(-2px); box-shadow:0 4px 12px rgba(0,0,0,.15);}
    .division-btn.active{ color:white; border-color:transparent;}
    .division-btn.all.active{ background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);}
    .division-btn.tree.active{ background:linear-gradient(135deg,#56ab2f 0%,#a8e063 100%);}
    .division-btn.stone.active{ background:linear-gradient(135deg,#4b6cb7 0%,#182848 100%);}
    .division-btn.gravel.active{ background:linear-gradient(135deg,#f2994a 0%,#f2c94c 100%);}
    .stats{ display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); gap:20px; padding:30px; background:#f8f9fa;}
    .stat-card{ background:white; padding:20px; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,.1);}
    .stat-number{ font-size:2.5em; font-weight:700; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); background-clip:text; -webkit-background-clip:text; -webkit-text-fill-color:transparent;}
    .stat-label{ color:#6c757d; font-size:.9em; margin-top:5px;}
    .controls{ padding:30px; background:white; border-bottom:2px solid #e9ecef;}
    .search-box{ display:flex; gap:10px; margin-bottom:20px; flex-wrap:wrap;}
    input,select{ flex:1; min-width:200px; padding:12px; border:2px solid #ddd; border-radius:8px; font-size:16px;}
    button{ padding:12px 30px; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:white; border:none; border-radius:8px; cursor:pointer; font-size:16px; font-weight:600; transition:all .3s;}
    button:hover{ transform:translateY(-2px); box-shadow:0 4px 12px rgba(102,126,234,.4);}
    button:disabled{ opacity:.5; cursor:not-allowed; transform:none;}
    .export-btn{ background:linear-gradient(135deg,#11998e 0%,#38ef7d 100%); margin-left:10px;}
    .results{ padding:30px; min-height:400px;}
    .loading{ text-align:center; padding:60px; color:#667eea; font-size:1.2em;}
    .rfp-card{ background:white; border:2px solid #e9ecef; border-radius:12px; padding:20px; margin-bottom:15px; transition:all .3s;}
    .rfp-card:hover{ border-color:#667eea; box-shadow:0 4px 12px rgba(102,126,234,.1); transform:translateX(5px);}
    .rfp-title{ font-size:1.3em; font-weight:700; color:#2c3e50; margin-bottom:8px;}
    .division-badge{ display:inline-block; padding:6px 12px; border-radius:6px; font-size:.85em; font-weight:600; color:white; margin-right:10px;}
    .badge-tree{ background:linear-gradient(135deg,#56ab2f 0%,#a8e063 100%);}
    .badge-stone{ background:linear-gradient(135deg,#4b6cb7 0%,#182848 100%);}
    .badge-gravel{ background:linear-gradient(135deg,#f2994a 0%,#f2c94c 100%);}
    .badge-multi{ background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);}
    .rfp-meta{ display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:12px; margin-top:15px; font-size:.95em; color:#6c757d;}
    .meta-label{ font-weight:600; color:#495057; margin-right:5px;}
    .value-badge{ display:inline-block; padding:4px 12px; background:linear-gradient(135deg,#11998e 0%,#38ef7d 100%); color:white; border-radius:6px; font-weight:600; font-size:1.1em;}
    .no-results{ text-align:center; padding:60px; color:#6c757d; font-size:1.2em;}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üèóÔ∏è Dunning Industries RFP Tracker</h1>
      <p>Multi-Division Government Contract Opportunities</p>
    </header>

    <div class="divisions">
      <button class="division-btn all active" onclick="setDivision('all')">All Divisions</button>
      <button class="division-btn tree" onclick="setDivision('tree')">üå≥ Tree & Landscape</button>
      <button class="division-btn stone" onclick="setDivision('stone')">ü™® Stone & Supply</button>
      <button class="division-btn gravel" onclick="setDivision('gravel')">‚õèÔ∏è Sand & Gravel</button>
    </div>

    <div class="stats">
      <div class="stat-card"><div class="stat-number" id="totalRFPs">0</div><div class="stat-label">Total Opportunities</div></div>
      <div class="stat-card"><div class="stat-number" id="totalValue">$0</div><div class="stat-label">Total Contract Value</div></div>
      <div class="stat-card"><div class="stat-number" id="highValue">0</div><div class="stat-label">High-Value ($100K+)</div></div>
    </div>

    <div class="controls">
      <div class="search-box">
        <input type="text" id="keyword" placeholder="Search keywords (optional)">
        <select id="state">
          <option value="">All States</option>
          <option value="CT">Connecticut</option>
          <option value="NY">New York</option>
          <option value="MA">Massachusetts</option>
          <option value="RI">Rhode Island</option>
        </select>
        <input type="number" id="minValue" placeholder="Min Value ($)" min="0">
        <select id="searchType">
          <option value="active">Active RFPs</option>
          <option value="awarded">Awarded Contracts (Past Winners)</option>
        </select>
        <button onclick="searchRFPs()" id="searchBtn">üîç Search Opportunities</button>
        <button class="export-btn" onclick="exportToCSV()" id="exportBtn">üìä Export CSV</button>
      </div>
    </div>

    <div class="results" id="results">
      <div class="no-results">Click "Search Opportunities" to find RFPs for your selected division</div>
    </div>
  </div>

  <script>
    let currentDivision = 'all';
    let allResults = [];

    const divisions = {
      tree: { name: 'Tree & Landscape', keywords: ['tree','landscape','nursery','landscaping','grounds','arborist','lawn','park'] },
      stone: { name: 'Stone & Supply', keywords: ['stone','masonry','hardscape','paving','brick','concrete','building materials','retaining'] },
      gravel: { name: 'Sand & Gravel', keywords: ['sand','gravel','aggregate','crushed stone','construction materials','excavation','fill'] }
    };

    function setDivision(div) {
      currentDivision = div;
      document.querySelectorAll('.division-btn').forEach(b => b.classList.remove('active'));
      const el = document.querySelector('.division-btn.' + div);
      if (el) el.classList.add('active');
    }

    function detectDivision(title) {
      const text = (title || '').toLowerCase();
      let matches = [];
      Object.keys(divisions).forEach(key => {
        if (divisions[key].keywords.some(kw => text.includes(kw))) matches.push(key);
      });
      return matches.length > 1 ? 'multi' : matches.length === 1 ? matches[0] : 'tree';
    }

    async function searchRFPs() {
      const btn = document.getElementById('searchBtn');
      const results = document.getElementById('results');
      btn.disabled = true;
      results.innerHTML = '<div class="loading">‚è≥ Searching SAM.gov database...</div>';

      try {
        const useDemoData = localStorage.getItem('useDemoData') === 'true';
        if (useDemoData) {
          // Demo data for testing the interface
          await new Promise(resolve => setTimeout(resolve, 500));
          allResults = [
            {
              noticeId: 'DEMO-001',
              solicitationNumber: 'W912DQ-25-R-0001',
              title: 'Tree Trimming and Removal Services - Fort Devens',
              fullParentPathName: 'DEPT OF DEFENSE.DEPT OF THE ARMY',
              postedDate: new Date().toISOString(),
              responseDeadLine: new Date(Date.now() + 30*24*60*60*1000).toISOString(),
              division: 'tree',
              estimatedValue: 125000
            },
            {
              noticeId: 'DEMO-002',
              solicitationNumber: 'CT-DOT-2025-045',
              title: 'Aggregate Stone and Gravel Supply for Highway Maintenance',
              fullParentPathName: 'STATE OF CONNECTICUT.DEPT OF TRANSPORTATION',
              postedDate: new Date().toISOString(),
              responseDeadLine: new Date(Date.now() + 45*24*60*60*1000).toISOString(),
              division: 'gravel',
              estimatedValue: 275000
            },
            {
              noticeId: 'DEMO-003',
              solicitationNumber: 'NYC-PWD-2025-132',
              title: 'Masonry and Stone Supply for City Parks',
              fullParentPathName: 'CITY OF NEW YORK.PUBLIC WORKS DEPT',
              postedDate: new Date().toISOString(),
              responseDeadLine: new Date(Date.now() + 20*24*60*60*1000).toISOString(),
              division: 'stone',
              estimatedValue: 85000
            },
            {
              noticeId: 'DEMO-AWARD-001',
              solicitationNumber: 'MA-DPW-2024-089',
              title: 'üèÜ Tree Trimming Services - State Highway System (AWARDED)',
              fullParentPathName: 'STATE OF MASSACHUSETTS.DEPT OF PUBLIC WORKS',
              postedDate: new Date(Date.now() - 180*24*60*60*1000).toISOString(),
              awardDate: new Date(Date.now() - 90*24*60*60*1000).toISOString(),
              division: 'tree',
              estimatedValue: 450000,
              awardAmount: 425000,
              awardee: 'Green Valley Tree Service Inc',
              type: 'Award Notice',
              baseType: 'Award Notice'
            },
            {
              noticeId: 'DEMO-AWARD-002',
              solicitationNumber: 'CT-DOT-2024-112',
              title: 'üèÜ Crushed Stone Aggregate Supply Contract (AWARDED)',
              fullParentPathName: 'STATE OF CONNECTICUT.DEPT OF TRANSPORTATION',
              postedDate: new Date(Date.now() - 240*24*60*60*1000).toISOString(),
              awardDate: new Date(Date.now() - 120*24*60*60*1000).toISOString(),
              division: 'gravel',
              estimatedValue: 650000,
              awardAmount: 589000,
              awardee: 'Northeast Aggregates LLC',
              type: 'Award Notice',
              baseType: 'Award Notice'
            }
          ];
          displayResults();
          updateStats();
          btn.disabled = false;
          return;
        }
        
        const today = new Date();
        const oneYearAgo = new Date(today);
        oneYearAgo.setFullYear(today.getFullYear() - 1);
        const formatDate = d => `${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}/${d.getFullYear()}`;

        let searchTerms = currentDivision === 'all' ? ['landscape'] : [divisions[currentDivision].keywords[0]];
        const keyword = document.getElementById('keyword').value.trim();
        if (keyword) searchTerms = [keyword];
        const state = document.getElementById('state').value;
        const minValue = document.getElementById('minValue').value;
        const searchType = document.getElementById('searchType').value;
        
        const isAwardedSearch = searchType === 'awarded';

        allResults = [];
        for (let i = 0; i < searchTerms.length; i++) {
          const term = searchTerms[i];
          const params = new URLSearchParams({
            postedFrom: formatDate(oneYearAgo),
            postedTo: formatDate(today),
            limit: '100'
          });
          if (term) params.append('title', term);
          if (state) params.append('state', state);
          
          // Add award-specific parameters
          if (isAwardedSearch) {
            params.append('latest', 'No');  // Get all notices including archived
            params.append('type', 'a,i,j');  // a=Award, i=Intent to Bundle, j=Justification
          }

          const url = `/proxy/search?${params.toString()}`;
          const response = await fetch(url);
          
          if (!response.ok) {
            console.warn(`Request failed with status ${response.status}`);
            if (response.status === 429) {
              results.innerHTML = '<div class="no-results">‚è±Ô∏è SAM.gov rate limit reached. <br><br>Wait 5-10 minutes or <button onclick="enableDemoMode()" style="display:inline-block;margin-top:10px;padding:8px 16px;background:#667eea;color:white;border:none;border-radius:6px;cursor:pointer;">Try Demo Mode</button></div>';
              btn.disabled = false;
              return;
            }
            continue;
          }
          
          const data = await response.json();
          const items = data.opportunitiesData || data.opportunities || data;
          if (Array.isArray(items)) {
            items.forEach(opp => {
              const id = opp.noticeId || opp.solicitationNumber || (opp.id || '');
              if (!allResults.find(r => r.noticeId === id || r.solicitationNumber === id)) {
                const title = opp.title || opp.noticeTitle || opp.description || '';
                const div = detectDivision(title);
                const value = extractValue(title + ' ' + (opp.description || ''));
                if (!minValue || value >= parseInt(minValue,10)) {
                  allResults.push({...opp, division: div, estimatedValue: value, noticeId: id});
                }
              }
            });
          }
          
          // Add delay between requests to avoid rate limiting (only if more searches remain)
          if (i < searchTerms.length - 1) {
            await new Promise(resolve => setTimeout(resolve, 1000));
          }
        }

        displayResults();
        updateStats();
      } catch (err) {
        document.getElementById('results').innerHTML = '<div class="no-results">‚ùå Error searching. Please try again.</div>';
        console.error(err);
      } finally {
        btn.disabled = false;
      }
    }

    function extractValue(text) {
      if (!text) return 0;
      const moneyMatches = text.match(/\$[\d,]+(\.\d{2})?/g);
      if (moneyMatches && moneyMatches.length) {
        const nums = moneyMatches.map(m => parseFloat(m.replace(/[$,]/g,'')));
        return Math.max(...nums);
      }
      const kMatches = text.match(/([\d,.]+)\s*k\b/gi);
      if (kMatches) {
        const nums = kMatches.map(m => parseFloat(m.replace(/[,kK]/g,'')) * 1000);
        return Math.max(...nums);
      }
      const plainNumbers = (text.match(/[\d,]{4,}/g) || []).map(n => parseInt(n.replace(/,/g,''),10));
      return plainNumbers.length ? Math.max(...plainNumbers) : 0;
    }

    function formatMoney(v){ return v ? ('$' + v.toLocaleString()) : '$0'; }

    function displayResults(){
      const results = document.getElementById('results');
      if (!allResults || allResults.length===0) { results.innerHTML = '<div class="no-results">No opportunities found. Try different search criteria.</div>'; return; }
      let html = '';
      allResults.forEach(opp => {
        const divKey = opp.division || 'multi';
        const badgeClass = `badge-${divKey}`;
        const divName = divKey === 'multi' ? 'Multiple Divisions' : (divisions[divKey]?.name || 'General');
        const title = opp.title || opp.noticeTitle || 'Untitled Opportunity';
        const posted = opp.postedDate ? new Date(opp.postedDate).toLocaleDateString() : (opp.posted ? new Date(opp.posted).toLocaleDateString() : 'N/A');
        const deadline = opp.responseDeadLine ? new Date(opp.responseDeadLine).toLocaleDateString() : (opp.noticeCloseDate ? new Date(opp.noticeCloseDate).toLocaleDateString() : 'N/A');
        const id = opp.solicitationNumber || opp.noticeId || 'N/A';
        const agency = opp.fullParentPathName || opp.principalPlaceOfPerformance || opp.agency || 'N/A';
        const valueHtml = opp.estimatedValue > 0 ? `<div><span class="meta-label">Est. Value:</span><span class="value-badge">${formatMoney(opp.estimatedValue)}</span></div>` : '';
        
        // Extract winner information for awarded contracts
        const isAwarded = opp.type === 'Award Notice' || opp.baseType === 'Award Notice' || opp.noticeType === 'Award Notice';
        const awardee = opp.awardee || opp.awardedVendor || opp.contractorName || '';
        const awardDate = opp.awardDate ? new Date(opp.awardDate).toLocaleDateString() : '';
        const awardAmount = opp.awardAmount || opp.awardDollars || opp.estimatedValue || 0;
        
        let winnerHtml = '';
        if (isAwarded && awardee) {
          winnerHtml = `
            <div style="grid-column: 1/-1; margin-top:10px; padding-top:10px; border-top:2px solid #e9ecef;">
              <div style="font-weight:700; color:#11998e; margin-bottom:8px;">üèÜ AWARDED TO:</div>
              <div><span class="meta-label">Winner:</span>${escapeHtml(awardee)}</div>
              ${awardDate ? `<div><span class="meta-label">Award Date:</span>${escapeHtml(awardDate)}</div>` : ''}
              ${awardAmount > 0 ? `<div><span class="meta-label">Award Amount:</span><span class="value-badge">${formatMoney(awardAmount)}</span></div>` : ''}
            </div>`;
        }

        html += `
          <div class="rfp-card">
            <div class="rfp-title">
              <span class="division-badge ${badgeClass}">${divName}</span>
              ${isAwarded ? 'üèÜ ' : ''}${escapeHtml(title)}
            </div>
            <div class="rfp-meta">
              <div><span class="meta-label">RFP #:</span>${escapeHtml(id)}</div>
              <div><span class="meta-label">Agency:</span>${escapeHtml(agency)}</div>
              <div><span class="meta-label">Posted:</span>${escapeHtml(posted)}</div>
              <div><span class="meta-label">Deadline:</span>${escapeHtml(deadline)}</div>
              ${valueHtml}
              ${winnerHtml}
            </div>
          </div>`;
      });
      results.innerHTML = html;
    }

    function updateStats(){
      const total = allResults.length;
      const totalValue = allResults.reduce((s,r)=>s+(r.estimatedValue||0),0);
      const highValue = allResults.filter(r=>(r.estimatedValue||0)>=100000).length;
      document.getElementById('totalRFPs').textContent = total;
      document.getElementById('totalValue').textContent = formatMoney(totalValue);
      document.getElementById('highValue').textContent = highValue;
    }

    function exportToCSV(){
      if(!allResults||allResults.length===0){ alert('No data to export.'); return; }
      const header = ['RFP #','Title','Division','Agency','Posted','Deadline','EstimatedValue','Winner','AwardDate','AwardAmount','URL'];
      const rows = allResults.map(r=>{
        const title = r.title || r.noticeTitle || '';
        const id = r.solicitationNumber || r.noticeId || '';
        const division = r.division || '';
        const agency = r.fullParentPathName || r.agency || '';
        const posted = r.postedDate || r.posted || '';
        const deadline = r.responseDeadLine || r.noticeCloseDate || '';
        const value = r.estimatedValue || 0;
        const winner = r.awardee || r.awardedVendor || r.contractorName || '';
        const awardDate = r.awardDate || '';
        const awardAmount = r.awardAmount || r.awardDollars || 0;
        const url = r.noticeURL || (r.links && r.links.length ? r.links[0] : '') || '';
        return [id, title, division, agency, posted, deadline, value, winner, awardDate, awardAmount, url].map(f => `"${String(f || '').replace(/"/g,'""')}"`).join(',');
      });
      const csv = [header.join(','), ...rows].join('\r\n');
      const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
      const u = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = u;
      a.download = `rfp-results-${new Date().toISOString().slice(0,10)}.csv`;
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(u);
    }

    function escapeHtml(s){ return String(s||'').replace(/[&<>"'`=\/]/g, ch => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;' })[ch]); }

    function enableDemoMode() {
      localStorage.setItem('useDemoData', 'true');
      alert('Demo mode enabled! Click Search to see sample data.\n\nTo use real SAM.gov data later, wait 10 minutes and click "Disable Demo Mode" in the header.');
      location.reload();
    }

    function disableDemoMode() {
      localStorage.removeItem('useDemoData');
      alert('Demo mode disabled. Now using real SAM.gov API.');
      location.reload();
    }

    // Show demo mode indicator if active
    if (localStorage.getItem('useDemoData') === 'true') {
      const demoIndicator = document.createElement('div');
      demoIndicator.style.cssText = 'position:fixed;top:10px;right:10px;background:#ff6b6b;color:white;padding:8px 16px;border-radius:8px;font-size:14px;z-index:1000;box-shadow:0 2px 8px rgba(0,0,0,0.2);';
      demoIndicator.innerHTML = 'DEMO MODE <button onclick="disableDemoMode()" style="margin-left:10px;background:white;color:#ff6b6b;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;font-weight:600;">Disable</button>';
      document.body.appendChild(demoIndicator);
    }

    document.getElementById('keyword').addEventListener('keydown', e => { if (e.key === 'Enter') searchRFPs(); });
  </script>
</body>
</html>
